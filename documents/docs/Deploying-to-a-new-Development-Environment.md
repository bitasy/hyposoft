In order to deploy to a new development environment, certain steps must be taken to ensure the application runs correctly.

## Production Server
We currently deploy to an Ubuntu 18.04 image hosted by and AWS EC2 machine. Other machines and linux distributions may be sufficient but are untested. Our server uses Python version 3.6.9. The linux user executing the following commands must have sudo access without a password. This user must have a private key allowing access to gitlab.oit.duke.edu through a GitLab user with access to this repository, which must be set up on the GitLab website. To begin, run the command `git clone git@gitlab.oit.duke.edu:ban20/hyposoft-group-8.git hyposoft-deployed` in the user's home directory. This page assumes the user is `ubuntu`.

## Python
Run the following commands to install and prepare Python on the server.
1. `sudo apt-get install python3-pip`
2. `sudo apt-get install python3`

## uWSGI
Django is served using uWSGI. This needs to be set up on your deployment server using the following commands.
1. Run `sudo pip3 install uwsgi`.
2. Run `sudo apt-get install libpq-dev && pip3 install --no-binary :all: psycopg2`.
3. Create a file (creating directories as necessary) `/etc/uwsgi/vassals/uwsgi.ini` and place the following contents:
```
[uwsgi]
chdir=/home/ubuntu/hyposoft-deployed/app/hyposoft
module=hyposoft.wsgi:application
master=True
processes=10
threads=1
socket=/home/ubuntu/hyposoft.sock
chmod-socket=666
vacuum=True
safe-pidfile=/home/ubuntu/uwsgi.pid
```
3. In the home directory, run `wget https://raw.githubusercontent.com/nginx/nginx/master/conf/uwsgi_params`
4. uWSGI can be run using the command `sudo uwsgi --emperor /etc/uwsgi/vassals/`

Note: uWSGI must be running for the application to be accessible. You can keep it live in the background by using the linux `screen` command: 
* `sudo screen -dmS hyp_scr bash`
* `sudo screen -S hyp_scr -p 0 -X stuff "uwsgi --emperor /etc/uwsgi/vassals/ $(echo -ne '\r')"`

or an alternative of your choice.

## Nginx
The application uses a Nginx web server to handle requests from clients. The version we use is 1.14.0 for Ubuntu.
* `sudo apt-get install nginx=1.14.*`
The server serves static content generated by `django-admin collectstatic` and routes all other requests to Django via uWSGI. This connection is made via a Unix Web Socket. A sample nginx site configuration is below, please adapt to your own needs and write to `/etc/nginx/sites-enabled/hyposoft.conf`.

### hyposoft_nginx.conf
```
# the upstream component nginx needs to connect to
upstream django {
    server unix:///home/ubuntu/hyposoft.sock; # matches the socket file in the uwsgi.ini file above
}

# configuration of the server
server {
    listen 80 default_server;
    server_name hyposoft.tech; # substitute your machine's IP address or FQDN
    return 301 https://hyposoft.tech$request_uri;
}
server {
    # the port your site will be served on
    listen      443 ssl;
    # the domain name it will serve for
    server_name hyposoft.tech; # substitute your machine's IP address or FQDN
    charset     utf-8;

    # ssl
    ssl_certificate     /your/path/to/ssl/certificate; # Replace as needed
    ssl_certificate_key /your/path/to/ssl/certificate/key;


    # max upload size
    client_max_body_size 75M;   # adjust to taste

    # Django media
    location /media  {
        alias /home/ubuntu/hyposoft-deployed/app/hyposoft/media;  # your Django project's media files - amend as required
    }

    location /static {
        alias /home/ubuntu/hyposoft-deployed/app/hyposoft/static; # your Django project's static files - amend as required
    }

    # Finally, send all non-media requests to the Django server.
    location / {
        uwsgi_pass  django;
        include     /home/ubuntu/uwsgi_params; # the uwsgi_params file you installed
    }
}
```

After the file is saved, run the following commands to finish setting up nginx.
1. `sudo rm /etc/nginx/sites-enabled/default`
2. `sudo nginx -t` to test the configuration for syntax errors
3. `sudo nginx -s reload`

## Django
Install required dependencies by running `sudo pip3 install -r requirements.txt` in the hyposoft-deployed project directory.

The Django setup requires that some environment variables be set manually. Add these variables to /etc/bash.bashrc for sudo access, filling in the required information:
```
export DB_HOST="<Your Database Host URL>"
export DB_USER="<Your Database Username>"
export DB_PASS="<Your Database Password>"
export DB_NAME="<Your Database Name>"
export DJANGO_DEBUG=<True or False> # Python syntax, not bash syntax
```
To source these changes, run `sudo -s` followed by `source /etc/bash.bashrc` and `exit` to return to your user.

You may need to run `sudo uwsgi --reload uwsgi.pid` in order to start the Django server.

Lastly, create a Django administrator account for you to use. This can be done by navigating to the project root and using the command `python3 app/hyposoft/manage.py createsuperuser` and following the instructions.

## React
You must build the react files required to run the application client-side. Run the following commands:
1. `sudo apt-get install node npm`
2. `cd /home/ubuntu/hyposoft-deployed/app/hyposoft/frontend/`
3. `npm i`
4. `npm run build`
5. `cd ..`
6. `python3 manage.py collectstatic --no-input`